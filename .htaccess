#
# Sources:
# https://stackoverflow.com/questions/7704624/how-can-i-use-gzip-compression-for-css-and-js-files-on-my-websites
# https://codex.wordpress.org/Output_Compression
# https://www.perun.net/2009/06/06/wordpress-websites-beschleuinigen-4-ein-zwischenergebnis/#comment-61086
# https://www.smashingmagazine.com/smashing-book-1/performance-optimization-for-websites-part-2-of-2/
# https://gtmetrix.com/configure-entity-tags-etags.html

<IfModule mod_deflate.c>
  # Insert filters / compress text, html, javascript, css, xml:
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/js
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/x-httpd-php
  AddOutputFilterByType DEFLATE application/x-httpd-fastphp
  AddOutputFilterByType DEFLATE image/svg+xml

  # Ausnahme: Grafiken
  SetEnvIfNoCase REQUEST_URI \.(?:gif|jpg|jpeg|png|svg)$ no-gzip dont_vary

  # Drop problematic browsers
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSI[E] !no-gzip !gzip-only-text/html

  # Make sure proxies don't deliver the wrong content
  Header append Vary User-Agent env=!dont-vary
</IfModule>


## EXPIRES CACHING ##
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 1 week"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType text/html "access plus 1 minute"
  ExpiresByType text/plain "access plus 1 month"
  ExpiresByType application/pdf "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  ExpiresByType text/x-javascript "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 months"
  ExpiresByType application/x-javascript "access plus 1 months"
  ExpiresByType application/x-shockwave-flash "access plus 1 month"
  ExpiresByType image/x-icon "access plus 1 year"
</IfModule>
## EXPIRES CACHING ##


# Alternative caching using Apache's "mod_headers", if it's installed.
# Caching of common files - ENABLED
<IfModule mod_headers.c>
  <FilesMatch "\.(ico|pdf|flv|swf|js|css|gif|png|jpg|jpeg|txt|html|htm)$">
    Header set Cache-Control "max-age=2592000, public"
  </FilesMatch>
  <FilesMatch "\.(js|css|xml|gz)$">
    Header append Vary Accept-Encoding
  </FilesMatch>
  # Set Keep Alive Header
  Header set Connection keep-alive
  
  # Security Headers - CRITICAL
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-Content-Type-Options "nosniff"
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
  Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; img-src 'self' https: data:; font-src 'self' https: data:; connect-src 'self' https:; media-src 'self' https:; object-src 'none'; frame-src 'self' https://www.youtube.com https://youtube.com; base-uri 'self'; form-action 'self';"
</IfModule>

<IfModule mod_gzip.c>
  mod_gzip_on Yes
  mod_gzip_dechunk Yes
  mod_gzip_item_include file \.(html?|txt|css|js|php|pl)$
  mod_gzip_item_include handler ^cgi-script$
  mod_gzip_item_include mime ^text/.*
  mod_gzip_item_include mime ^application/x-javascript.*
  mod_gzip_item_exclude mime ^image/.*
  mod_gzip_item_exclude rspheader ^Content-Encoding:.*gzip.*
</IfModule>

# If your server supports ETags activate it with "All" otherwise deactivate with "None"
# FileETag All
# FileETag None

# Security: Block access to sensitive development files
# Note: README.md, .gitattributes, .gitignore covered by pattern rules below

# Block access to ALL Python files
<FilesMatch "\.py$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Block access to Python compiled files and caches
<FilesMatch "\.(pyc|pyo)$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Block access to shell scripts 
<FilesMatch "\.sh$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Note: Specific file protections removed - covered by pattern-based rules above

# Block access to ALL YAML files (development configurations)
<FilesMatch "\.(yml|yaml)$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Block access to development files (consolidated patterns)
<FilesMatch "^(\.env|\.env\..+|\.htaccess|\.htpasswd|\.gitattributes|\.gitignore|\.trivyignore|README\.md|SECURITY\.md|LICENSE|composer\.(json|lock)|package\.(json|lock)|yarn\.lock|Pipfile|Pipfile\.lock|setup\.py|setup\.cfg|tox\.ini|pytest\.ini)$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Block access to build and configuration files (consolidated)
<FilesMatch "^(bower\.json|Gruntfile\.js|gulpfile\.js|webpack\.config\.js|package\.json|dev-.*\.(json|js))$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Consolidated rewrite rules
<IfModule mod_rewrite.c>
  RewriteEngine on
  RewriteBase /
  
  # Security rules - Block cache directories and hidden files
  RewriteRule __pycache__/ - [F,L]
  RewriteRule \.pytest_cache/ - [F,L]
  RewriteRule (^|/)\.(?!well-known/) - [F,L]
  
  # Domain and URL management
  RewriteRule ^robots.txt$ ./prajitdas.github.io/robots.txt [NC,L]
  
  # Redirect www to non-www
  RewriteCond %{HTTP_HOST} ^www\.prajitdas\.github\.io$
  RewriteRule ^/?$ "https\:\/\/prajitdas\.github\.io\/" [R=301,L]
  
  # Redirect IP to domain
  RewriteCond %{HTTP_HOST} ^64\.227\.19\.194
  RewriteRule (.*) https://prajitdas.github.io/$1 [R=301,L]
  
  # Block libwww-perl user agents
  RewriteCond %{HTTP_USER_AGENT} libwww-perl.*
  RewriteRule .* ? [F,L]
</IfModule>

# Enforce or deny complete folder listing
IndexIgnore *

# Error page configuration
ErrorDocument 404 assets/error-pages/404/404.html
ErrorDocument 403 assets/error-pages/404/404.html
