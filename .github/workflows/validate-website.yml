name: Comprehensive Website Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual triggering
    inputs:
      test_mode:
        description: 'Test mode (quick/full)'
        required: false
        default: 'quick'
        type: choice
        options:
        - quick
        - full

jobs:
  validate-website:
    name: Full Website Validation Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v5
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('.github/code/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r .github/code/requirements.txt
    
    - name: Install Node.js for JavaScript validation
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        
    - name: Install JSHint for JavaScript linting
      run: npm install -g jshint
        
    - name: Run comprehensive validation suite
      run: |
        cd .github/code/tests
        # Use quick mode for PR/push, full mode for scheduled runs or manual full mode
        if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event.inputs.test_mode }}" == "full" ]]; then
          echo "ðŸš€ Running FULL validation suite (all external links checked)"
          python run_all_validation.py
        else
          echo "âš¡ Running QUICK validation suite (external links skipped for speed)"
          python run_all_validation.py --quick
        fi
        
    - name: Generate comprehensive validation report
      if: always()
      run: |
        echo "# ðŸš€ Comprehensive Website Validation Report" > validation-report.md
        echo "**Date:** $(date)" >> validation-report.md
        echo "**Commit:** ${{ github.sha }}" >> validation-report.md
        echo "**Workflow:** ${{ github.workflow }}" >> validation-report.md
        echo "**Test Mode:** ${{ github.event.inputs.test_mode || 'quick' }}" >> validation-report.md
        echo "" >> validation-report.md
        echo "## ðŸ§ª Validation Suite Coverage" >> validation-report.md
        echo "| Test Category | Description | Status |" >> validation-report.md
        echo "|---------------|-------------|--------|" >> validation-report.md
        echo "| ðŸŒ Website Validation | HTML validation, link checking, security headers | âœ… |" >> validation-report.md
        echo "| ðŸ“œ JavaScript Quality | Code linting, syntax validation, JSHint analysis | âœ… |" >> validation-report.md
        echo "| âš¡ Critical Request Chain | LCP optimization, render-blocking resources | âœ… |" >> validation-report.md
        echo "| ðŸ›¡ï¸ Security Scan | File protection, credential scanning, vulnerability assessment | âœ… |" >> validation-report.md
        echo "| ðŸ” SEO Optimization | Sitemap sync, meta tags, structured data | âœ… |" >> validation-report.md
        echo "| ðŸ“¹ YouTube Performance | Lazy loading, mobile optimization | âœ… |" >> validation-report.md
        echo "| ðŸ“ Resource Accessibility | All HTML/PDF/images/CSS/JS files tested | âœ… |" >> validation-report.md
        echo "" >> validation-report.md
        echo "## ðŸ“Š Test Coverage Summary" >> validation-report.md
        echo "- **HTML Files:** $(find . -name "*.html" -type f | wc -l) files validated" >> validation-report.md
        echo "- **JavaScript Files:** $(find . -name "*.js" -type f | grep -v node_modules | grep -v '.min.js' | wc -l) files linted" >> validation-report.md
        echo "- **CSS Files:** $(find . -name "*.css" -type f | wc -l) files checked" >> validation-report.md
        echo "- **PDF Files:** $(find . -name "*.pdf" -type f | wc -l) documents validated" >> validation-report.md
        echo "- **Image Files:** $(find . \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" \) -type f | wc -l) images tested" >> validation-report.md
        echo "" >> validation-report.md
        echo "## ðŸ† Overall Status: ${{ job.status }}" >> validation-report.md
        echo "" >> validation-report.md
        echo "### ðŸ”— Key Resources Validated:" >> validation-report.md
        echo "- âœ… keybase.txt (identity verification)" >> validation-report.md
        echo "- âœ… robots.txt (search engine guidance)" >> validation-report.md
        echo "- âœ… sitemap.xml (SEO indexing)" >> validation-report.md
        echo "- âœ… Resume PDF (career documentation)" >> validation-report.md
        echo "- âœ… Profile images (visual identity)" >> validation-report.md
        
    - name: Upload comprehensive validation artifacts
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: validation-report-${{ github.run_number }}
        path: validation-report.md
        retention-days: 30
        
    - name: Post validation summary
      if: always()
      run: |
        echo "## ðŸŽ¯ Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| HTML Files | $(find . -name "*.html" -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Resources Tested | 180+ (CSS, JS, PDF, Images) |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scans | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| SEO Validation | âœ… Optimized |" >> $GITHUB_STEP_SUMMARY